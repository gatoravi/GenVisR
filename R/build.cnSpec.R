#' Construct CN cohort plot
#' 
#' given a data frame construct a plot to display CN information for a group of samples
#' @name build.cnSpec
#' @param data_frame object of class data frame containing columns Chromosome, Start, Stop, CN, Sample
#' @param plot_title character string for title of plot
#' @param CN_low_colour character string specifying low value of colour gradient 
#' @param CN_high_colour character string specifying high value of colour gradient
#' @param x_lab_size integer specifying the size of the X label
#' @param y_lab_size integer specifying the size of the Y label
#' @param facet_lab_size integer specifying the size of the faceted labels
#' @param layers Additional layers to be plotted, can be a theme but must be a ggplot layer
#' @return ggplot object
#' @import scales
#' @import ggplot2

build.cnSpec <- function(data_frame, plot_title=NULL, CN_low_colour='#002EB8', CN_high_colour='#A30000', x_lab_size=12, y_lab_size=12, facet_lab_size=10, layers=NULL)
{
    CN_data <- na.omit(data_frame)
    dummy_data <- data_frame
  
    # Define Theme of plot
    theme <- theme(strip.text.y=element_text(size=facet_lab_size), strip.text.x=element_text(size=facet_lab_size), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), legend.position='right', axis.title.x=element_text(size=x_lab_size, face='bold'), axis.title.y=element_text(size=y_lab_size, face='bold'))
  
    # Define parameters of plot
    facet <- facet_grid(sample ~ chromosome, scales='free', space='free')
    #fill_gradient <- scale_fill_gradient2(midpoint=0, low='#009ACD', mid='#646082', high='#C82536', limits=c(-2, 2))
    fill_gradient <- scale_fill_gradientn(colours = c(CN_low_colour, 'white', CN_high_colour), limits=c(-2, 2), name = element_text("Copy number\ndifference\n(Tumor - Normal)"), oob = squish)
    ylabel <- ylab('')
    xlabel <- xlab('')
    title <- ggtitle(plot_title)
    if(!is.null(layers))
    {
        layers <- layers
    } else {
        layers <- geom_blank()
    }
  
    # Define main plot using boundaries in dummy data and then plot CN data
    p1 <- ggplot(data=dummy_data, mapping=aes_string(xmin='start', xmax='end', ymin=0, ymax=1)) + geom_rect(alpha=0) + scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0))
    p1 <- p1 + geom_rect(data=CN_data, mapping=aes_string(xmin='start', xmax='end', ymin=0, ymax=1, fill='cn'))
  
    # build the plot
    p1 <- p1 + fill_gradient + ylabel + xlabel + facet + theme_bw() + theme + layers
  
    # if title is supplied plot it
    if(!is.null(plot_title))
    {
        p1 <- p1 + title
    }
  
    return(p1)	
}
